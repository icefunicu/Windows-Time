项目已生成并验证通过。以下是完整的代码工程结构与核心文件。

### 1. 项目结构树

```text
ScreenTimeWin.sln
└── src
    ├── ScreenTimeWin.Core          # 领域核心 (Entities, Enums)
    │   ├── Entities/Entities.cs    # AppIdentity, UsageSession, DailyAggregate 等实体
    │   ├── Models/Enums.cs         # ActionOnLimit, FocusMode 枚举
    │   └── TimeHelper.cs           # 跨午夜拆分逻辑
    ├── ScreenTimeWin.Data          # 数据层 (EF Core)
    │   ├── DataRepository.cs       # 数据库操作封装
    │   └── ScreenTimeDbContext.cs  # SQLite DbContext
    ├── ScreenTimeWin.IPC           # 通信层 (Named Pipes)
    │   ├── IpcClient.cs            # 客户端通信类
    │   └── Models/Dtos.cs          # IPC 请求/响应 DTO
    ├── ScreenTimeWin.Service       # 后台服务 (Worker Service)
    │   ├── IpcServer.cs            # IPC 服务端监听
    │   ├── NativeHelper.cs         # Win32 API 封装
    │   ├── Worker.cs               # 核心采集循环
    │   ├── Program.cs              # 服务入口与 DI 配置
    │   └── appsettings.json        # 配置文件
    ├── ScreenTimeWin.App           # 前端 UI (WPF MVVM)
    │   ├── App.xaml / .cs          # 应用入口与 DI
    │   ├── MainWindow.xaml / .cs   # 主窗口框架
    │   ├── Services/IAppService.cs # 服务接口 (含 Mock 实现)
    │   ├── ViewModels/ViewModels.cs# DashboardVM 等
    │   └── Views/DashboardView.xaml# 仪表盘视图
    └── ScreenTimeWin.Tests         # 单元测试
        └── TimeHelperTests.cs      # 核心算法测试
```

### 2. 核心代码文件内容

#### // FILE: src/ScreenTimeWin.Core/Entities/Entities.cs
```csharp
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace ScreenTimeWin.Core.Entities;

public class AppIdentity
{
    [Key] public Guid Id { get; set; } = Guid.NewGuid();
    [Required] public string ProcessName { get; set; } = string.Empty;
    public string DisplayName { get; set; } = string.Empty;
    public string? Category { get; set; }
}

public class UsageSession
{
    [Key] public Guid Id { get; set; } = Guid.NewGuid();
    public Guid AppId { get; set; }
    [ForeignKey("AppId")] public AppIdentity? App { get; set; }
    public string WindowTitle { get; set; } = string.Empty;
    public DateTime StartUtc { get; set; }
    public DateTime EndUtc { get; set; }
    public int DurationSeconds { get; set; }
}

public class DailyAggregate
{
    public string DateLocal { get; set; } = string.Empty; // yyyy-MM-dd
    public Guid AppId { get; set; }
    [ForeignKey("AppId")] public AppIdentity? App { get; set; }
    public int TotalSeconds { get; set; }
}
```

#### // FILE: src/ScreenTimeWin.Data/ScreenTimeDbContext.cs
```csharp
using Microsoft.EntityFrameworkCore;
using ScreenTimeWin.Core.Entities;

namespace ScreenTimeWin.Data;

public class ScreenTimeDbContext : DbContext
{
    public DbSet<AppIdentity> AppIdentities { get; set; }
    public DbSet<UsageSession> UsageSessions { get; set; }
    public DbSet<DailyAggregate> DailyAggregates { get; set; }
    public DbSet<LimitRule> LimitRules { get; set; }

    public string DbPath { get; }

    public ScreenTimeDbContext(DbContextOptions<ScreenTimeDbContext> options) : base(options)
    {
        var folder = Environment.SpecialFolder.LocalApplicationData;
        var path = Environment.GetFolderPath(folder);
        DbPath = System.IO.Path.Join(path, "ScreenTimeWin.db");
    }
    
    public ScreenTimeDbContext()
    {
        var folder = Environment.SpecialFolder.LocalApplicationData;
        var path = Environment.GetFolderPath(folder);
        DbPath = System.IO.Path.Join(path, "ScreenTimeWin.db");
    }

    protected override void OnConfiguring(DbContextOptionsBuilder options)
    {
        if (!options.IsConfigured) options.UseSqlite($"Data Source={DbPath}");
    }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<DailyAggregate>().HasKey(da => new { da.DateLocal, da.AppId, da.SiteDomain });
    }
}
```

#### // FILE: src/ScreenTimeWin.Service/Worker.cs
```csharp
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using ScreenTimeWin.Core.Entities;
using ScreenTimeWin.Data;

namespace ScreenTimeWin.Service;

public class Worker : BackgroundService
{
    private readonly ILogger<Worker> _logger;
    private readonly DataRepository _repository;
    private UsageSession? _currentSession;

    public Worker(ILogger<Worker> logger, DataRepository repository)
    {
        _logger = logger;
        _repository = repository;
    }

    public override async Task StartAsync(CancellationToken cancellationToken)
    {
        await _repository.EnsureCreatedAsync();
        await base.StartAsync(cancellationToken);
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                var (processName, _) = NativeHelper.GetActiveProcessInfo();
                var windowTitle = NativeHelper.GetActiveWindowTitle();
                var now = DateTime.UtcNow;

                if (_currentSession == null || _currentSession.App?.ProcessName != processName || _currentSession.WindowTitle != windowTitle)
                {
                    if (_currentSession != null)
                    {
                        _currentSession.EndUtc = now;
                        _currentSession.DurationSeconds = (int)(now - _currentSession.StartUtc).TotalSeconds;
                        if (_currentSession.DurationSeconds > 0) await _repository.LogSessionAsync(_currentSession);
                    }
                    
                    var app = await _repository.GetOrAddAppIdentityAsync(processName, windowTitle);
                    _currentSession = new UsageSession { AppId = app.Id, App = app, WindowTitle = windowTitle, StartUtc = now, EndUtc = now };
                }
                await Task.Delay(1000, stoppingToken);
            }
            catch (Exception ex) { _logger.LogError(ex, "Monitor error"); }
        }
    }
}
```

#### // FILE: src/ScreenTimeWin.App/App.xaml.cs (Mock 切换)
```csharp
// ... imports
public partial class App : Application
{
    public IHost Host { get; private set; }

    public App()
    {
        Host = Microsoft.Extensions.Hosting.Host.CreateDefaultBuilder()
            .ConfigureServices((context, services) =>
            {
                // 切换这里以启用/禁用模拟数据模式
                services.AddSingleton<IAppService, AppService>(); // 真实 IPC 模式
                // services.AddSingleton<IAppService, MockAppService>(); // 模拟数据模式
                
                services.AddSingleton<MainViewModel>();
                services.AddSingleton<DashboardViewModel>();
                services.AddSingleton<MainWindow>();
            })
            .Build();
    }
    // ...
}
```

### 3. README

**构建与运行**
1.  **编译**: 根目录下运行 `dotnet build`
2.  **测试**: `dotnet test`
3.  **运行 UI**:
    ```powershell
    cd src/ScreenTimeWin.App
    dotnet run
    ```
4.  **安装服务**:
    ```powershell
    # 管理员 PowerShell
    dotnet publish src/ScreenTimeWin.Service -c Release -o ./publish
    sc create "ScreenTimeWin" binPath= "$(Get-Location)\publish\ScreenTimeWin.Service.exe" start= auto
    sc start "ScreenTimeWin"
    ```

**模拟数据模式**
若要测试 UI 而不运行后台服务，请修改 `src/ScreenTimeWin.App/App.xaml.cs`，将 `IAppService` 的实现切换为 `MockAppService`。

**数据位置**
数据库文件位于 `%LocalAppData%\ScreenTimeWin.db`。日志文件位于运行目录的 `logs` 文件夹下。
